# Logging Specifications

## 1. Overview

Logging is crucial for monitoring the application's behavior, diagnosing issues, and understanding media playback history. Two main log files will be maintained:

*   `server.log`: For backend (Flask) application logs.
*   `mpv.log`: For logs generated by the MPV media player.

Both files will be stored in the project's root directory for easy access via SSH.

## 2. Backend Logging (`server.log`)

*   **Mechanism**: Python's built-in `logging` module, configured within the Flask application (`main.py` or a dedicated `logging_config.py`).
*   **Log Format**:
    ```
    [TIMESTAMP] [LEVEL] [MODULE] MESSAGE
    Example: [2025-05-14 10:00:00,123] [INFO] [main] Server started on http://0.0.0.0:5000
    Example: [2025-05-14 10:01:15,456] [ERROR] [mpv_controller] Failed to play media.mp4: File not found
    ```
*   **Log Level**: Configurable, default to `INFO`. `DEBUG` for more verbose output during development.
*   **Information to Log**:
    *   Server start and stop.
    *   Incoming HTTP requests (method, path, client IP).
    *   API endpoint calls and their success/failure status.
    *   Media upload events (filename, success/failure).
    *   Playback control actions (play, pause, stop, next, previous, item selection).
    *   Current media item being played.
    *   Errors and exceptions encountered.
    *   Changes in settings (loop toggle, transition selection).
    *   Playlist modifications (clear, item added).

*   **Implementation (`logging_config.py` or in `main.py`):**

    ```python
    # In logging_config.py (or directly in main.py)
    import logging
    from logging.handlers import RotatingFileHandler
    import os

    def setup_logging(app, log_path="server.log"):
        # Ensure log directory exists if log_path includes a directory
        # log_dir = os.path.dirname(log_path)
        # if log_dir and not os.path.exists(log_dir):
        #    os.makedirs(log_dir)

        # Basic configuration
        log_formatter = logging.Formatter('[%(asctime)s] [%(levelname)s] [%(module)s] %(message)s')
        
        # File Handler
        # Use RotatingFileHandler for production to prevent log files from growing indefinitely
        file_handler = RotatingFileHandler(log_path, maxBytes=1024*1024*5, backupCount=5) # 5MB per file, 5 backups
        file_handler.setFormatter(log_formatter)
        file_handler.setLevel(logging.INFO) # Set default level for file

        # Console Handler (optional, for development)
        # console_handler = logging.StreamHandler()
        # console_handler.setFormatter(log_formatter)
        # console_handler.setLevel(logging.DEBUG)

        # Get Flask's default logger and add handlers
        # For Flask app itself:
        app.logger.addHandler(file_handler)
        # app.logger.addHandler(console_handler) # If console output also desired
        app.logger.setLevel(logging.INFO)

        # For other modules, you can get a logger instance:
        # logger = logging.getLogger(__name__)
        # logger.addHandler(file_handler)
        # logger.setLevel(logging.INFO)

        app.logger.info("Logging configured. Server starting...")

    # In main.py:
    # from logging_config import setup_logging
    # app = Flask(__name__)
    # setup_logging(app, log_path="../server.log") # Assuming main.py is in app/
    ```
    Adjust `log_path` based on where `main.py` is relative to the desired `server.log` location. If `main.py` is in `app/` and logs are in root, it's `../server.log`.

## 3. MPV Logging (`mpv.log`)

*   **Mechanism**: MPV's native logging capabilities, configured via command-line arguments.
*   **Log Format**: MPV's default format.
*   **Log Level**: Configurable, e.g., `info`, `v` (verbose), `debug`.
*   **Information to Log**:
    *   MPV initialization and version.
    *   File loading (success, failure, path).
    *   Playback events (start, stop, pause, seek).
    *   Errors related to codecs, files, or display.
    *   Applied filters or options.
*   **Implementation**:
    *   The `mpv_controller.py` will add logging arguments when launching MPV.
    *   Example arguments: `--log-file=../mpv.log --msg-level=all=info` (path relative to where MPV is launched from, or use absolute path).
    *   The path to `mpv.log` should be consistent and point to the project root.

    ```python
    # In mpv_controller.py, when forming the command:
    # self.log_file = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'mpv.log'))
    # cmd = ['mpv', ..., '--log-file=' + self.log_file, '--msg-level=all=info']
    ```

## 4. Log Rotation and Management

*   **`server.log`**: Python's `RotatingFileHandler` will manage log rotation (size-based, keeping a few backup files).
*   **`mpv.log`**: MPV does not have built-in log rotation in the same way.
    *   **Simple Approach**: MPV will append to the log file. It might grow large over time.
    *   **Advanced (Manual/External)**: A separate cron job or script could be set up on the Raspberry Pi to periodically archive or clear `mpv.log` if it becomes too large. For simplicity, this is initially out of scope.

## 5. Accessing Logs

*   Logs are plain text files.
*   Access them by SSHing into the Raspberry Pi and using commands like `cat`, `tail -f`, `less`, or `grep` in the project root directory.
    *   `tail -f server.log` (to monitor live server activity)
    *   `tail -f mpv.log` (to monitor live MPV activity)

## 6. Security and Privacy

*   Logs should not contain sensitive personal data. For this application, filenames and IP addresses are the primary PII-like data.
*   Ensure log file permissions are set appropriately if the application runs under a specific user, to prevent unauthorized access (though for a local single-user Pi setup, this is less critical).
